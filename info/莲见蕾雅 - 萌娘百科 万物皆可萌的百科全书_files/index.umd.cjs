(function(g,m){typeof exports=="object"&&typeof module<"u"?m(exports):typeof define=="function"&&define.amd?define(["exports"],m):(g=typeof globalThis<"u"?globalThis:g||self,m(g.MoeAuthModal={}))})(this,function(g){"use strict";var m;(function(e){e.Call="call",e.Reply="reply",e.Syn="syn",e.SynAck="synAck",e.Ack="ack"})(m||(m={}));var C;(function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"})(C||(C={}));var A;(function(e){e.ConnectionDestroyed="ConnectionDestroyed",e.ConnectionTimeout="ConnectionTimeout",e.NoIframeSrc="NoIframeSrc"})(A||(A={}));var v;(function(e){e.DataCloneError="DataCloneError"})(v||(v={}));var E;(function(e){e.Message="message"})(E||(E={}));const x=(e,o)=>{const t=[];let r=!1;return{destroy(n){r||(r=!0,o(`${e}: Destroying connection`),t.forEach(s=>{s(n)}))},onDestroy(n){r?n():t.push(n)}}},K=e=>(...o)=>{},Y={"http:":"80","https:":"443"},V=/^(https?:)?\/\/([^/:]+)?(:(\d+))?/,q=["file:","data:"],z=e=>{if(e&&q.find(a=>e.startsWith(a)))return"null";const o=document.location,t=V.exec(e);let r,n,s;t?(r=t[1]?t[1]:o.protocol,n=t[2],s=t[4]):(r=o.protocol,n=o.hostname,s=o.port);const c=s&&s!==Y[r]?`:${s}`:"";return`${r}//${n}${c}`},D=({name:e,message:o,stack:t})=>({name:e,message:o,stack:t}),W=e=>{const o=new Error;return Object.keys(e).forEach(t=>o[t]=e[t]),o},X=(e,o,t)=>{const{localName:r,local:n,remote:s,originForSending:c,originForReceiving:a}=e;let u=!1;const d=i=>{if(i.source!==s||i.data.penpal!==m.Call)return;if(a!=="*"&&i.origin!==a){t(`${r} received message from origin ${i.origin} which did not match expected origin ${a}`);return}const y=i.data,{methodName:p,args:f,id:M}=y;t(`${r}: Received ${p}() call`);const R=h=>S=>{if(t(`${r}: Sending ${p}() reply`),u){t(`${r}: Unable to send ${p}() reply due to destroyed connection`);return}const w={penpal:m.Reply,id:M,resolution:h,returnValue:S};h===C.Rejected&&S instanceof Error&&(w.returnValue=D(S),w.returnValueIsError=!0);try{s.postMessage(w,c)}catch(l){if(l.name===v.DataCloneError){const P={penpal:m.Reply,id:M,resolution:C.Rejected,returnValue:D(l),returnValueIsError:!0};s.postMessage(P,c)}throw l}};new Promise(h=>h(o[p].apply(o,f))).then(R(C.Fulfilled),R(C.Rejected))};return n.addEventListener(E.Message,d),()=>{u=!0,n.removeEventListener(E.Message,d)}};let B=0;const G=()=>++B,O=".",F=e=>e?e.split(O):[],Q=e=>e.join(O),J=(e,o)=>{const t=F(o||"");return t.push(e),Q(t)},Z=(e,o,t)=>{const r=F(o);return r.reduce((n,s,c)=>(typeof n[s]>"u"&&(n[s]={}),c===r.length-1&&(n[s]=t),n[s]),e),e},j=(e,o)=>{const t={};return Object.keys(e).forEach(r=>{const n=e[r],s=J(r,o);typeof n=="object"&&Object.assign(t,j(n,s)),typeof n=="function"&&(t[s]=n)}),t},ee=e=>{const o={};for(const t in e)Z(o,t,e[t]);return o},te=(e,o,t,r,n)=>{const{localName:s,local:c,remote:a,originForSending:u,originForReceiving:d}=o;let i=!1;n(`${s}: Connecting call sender`);const y=f=>(...M)=>{n(`${s}: Sending ${f}() call`);let R;try{a.closed&&(R=!0)}catch{R=!0}if(R&&r(),i){const h=new Error(`Unable to send ${f}() call due to destroyed connection`);throw h.code=A.ConnectionDestroyed,h}return new Promise((h,S)=>{const w=G(),l=_=>{if(_.source!==a||_.data.penpal!==m.Reply||_.data.id!==w)return;if(d!=="*"&&_.origin!==d){n(`${s} received message from origin ${_.origin} which did not match expected origin ${d}`);return}const k=_.data;n(`${s}: Received ${f}() reply`),c.removeEventListener(E.Message,l);let N=k.returnValue;k.returnValueIsError&&(N=W(N)),(k.resolution===C.Fulfilled?h:S)(N)};c.addEventListener(E.Message,l);const P={penpal:m.Call,id:w,methodName:f,args:M};a.postMessage(P,u)})},p=t.reduce((f,M)=>(f[M]=y(M),f),{});return Object.assign(e,ee(p)),()=>{i=!0}},oe=(e,o,t,r,n)=>{const{destroy:s,onDestroy:c}=r;let a,u;const d={};return i=>{if(o!=="*"&&i.origin!==o){n(`Parent: Handshake - Received ACK message from origin ${i.origin} which did not match expected origin ${o}`);return}n("Parent: Handshake - Received ACK");const y={localName:"Parent",local:window,remote:i.source,originForSending:t,originForReceiving:o};a&&a(),a=X(y,e,n),c(a),u&&u.forEach(f=>{delete d[f]}),u=i.data.methodNames;const p=te(d,y,u,s,n);return c(p),d}},ne=(e,o,t,r)=>n=>{if(!n.source)return;if(t!=="*"&&n.origin!==t){e(`Parent: Handshake - Received SYN message from origin ${n.origin} which did not match expected origin ${t}`);return}e("Parent: Handshake - Received SYN, responding with SYN-ACK");const s={penpal:m.SynAck,methodNames:Object.keys(o)};n.source.postMessage(s,r)},re=6e4,se=(e,o)=>{const{destroy:t,onDestroy:r}=o,n=setInterval(()=>{e.isConnected||(clearInterval(n),t())},re);r(()=>{clearInterval(n)})},ce=(e,o)=>{let t;return e!==void 0&&(t=window.setTimeout(()=>{const r=new Error(`Connection timed out after ${e}ms`);r.code=A.ConnectionTimeout,o(r)},e)),()=>{clearTimeout(t)}},ae=e=>{if(!e.src&&!e.srcdoc){const o=new Error("Iframe must have src or srcdoc property defined.");throw o.code=A.NoIframeSrc,o}},ie=e=>{let{iframe:o,methods:t={},childOrigin:r,timeout:n,debug:s=!1}=e;const c=K(s),a=x("Parent",c),{onDestroy:u,destroy:d}=a;r||(ae(o),r=z(o.src));const i=r==="null"?"*":r,y=j(t),p=ne(c,y,r,i),f=oe(y,r,i,a,c);return{promise:new Promise((R,h)=>{const S=ce(n,d),w=l=>{if(!(l.source!==o.contentWindow||!l.data)){if(l.data.penpal===m.Syn){p(l);return}if(l.data.penpal===m.Ack){const P=f(l);P&&(S(),R(P));return}}};window.addEventListener(E.Message,w),c("Parent: Awaiting handshake"),se(o,a),u(l=>{window.removeEventListener(E.Message,w),l&&h(l)})}),destroy(){d()}}},de={doneAndReturnTo(e=!1){const o=new URL(window.location.href);let t=o.searchParams.get("returnto");if(typeof t!="string")if(e)t="";else return this.reloadTopWindow();const r=new URLSearchParams(o.searchParams.get("returntoquery")||"");window.mw?location.href=mw.util.getUrl(t,Object.fromEntries(r.entries())):(o.pathname=`/${t}`.replace(/^\/+/,"/"),o.search=o.searchParams.get("returntoquery")||"",location.href=o.href)},reloadTopWindow(){location.reload()},cancelAndClose(){throw new Error("Not implemented")},error(e){}};function le(e,o={},t=5e3){return ie({iframe:e,methods:{...de,...o},timeout:t})}const $={moe_auth_modal:"_moe_auth_modal_35ij6_1",open:"_open_35ij6_18",close:"_close_35ij6_22"},H="https://app.moegirl.org.cn/moe-auth/",T=Symbol("MoeAuthPreload");function L(){if(globalThis[T])return;globalThis[T]=!0;const e=document.createElement("link");e.rel="dns-prefetch",e.href="https://app.moegirl.org.cn",document.head.appendChild(e);const o=document.createElement("link");o.rel="preconnect",o.href="https://app.moegirl.org.cn",document.head.appendChild(o);const t=document.createElement("link");t.rel="preload",t.as="document",t.href=H,document.head.appendChild(t)}function ue(e,o){const t=new URL(H);return e=e.replace(/^#?\/+/,""),t.hash=`/${e}`,t.search=new URLSearchParams(o).toString(),t.toString()}function I(e,o="",t={},r={cancelAndClose(){this?.doneAndReturnTo?.(!0)}}){const n=document.createElement("iframe");n.src=ue(o,t),n.allow="clipboard-write; clipboard-read",n.loading="eager",e.innerHTML="",e.appendChild(n);const s=le(n,r),c=e.parentElement||document.body,a=new MutationObserver(u=>{for(const d of u){const i=Array.from(d.removedNodes);(i.includes(n)||i.includes(e))&&(s.destroy(),a.disconnect(),globalThis["".concat("console")].warn("MoeAuth iframe removed, RPC destroyed"))}});return a.observe(c,{childList:!0}),{iframe:n,rpc:s}}const U=b;function b(e="",o={},t){globalThis[T]=!0;const r=document.querySelector(`.${$.moe_auth_modal}`);r&&r.classList.add($.close);const n=t?.clientX||window.innerWidth/2,s=t?.clientY||window.innerHeight/2,c=document.createElement("div");c.classList.add($.moe_auth_modal),c.style.transformOrigin=n+"px "+s+"px",document.body.appendChild(c);const{iframe:a,rpc:u}=I(c,e,o,{cancelAndClose:()=>{d()}});a.addEventListener("load",()=>{c.classList.add($.open)}),c.addEventListener("transitionend",i=>{i.propertyName==="opacity"&&+getComputedStyle(c).opacity<=0&&c.remove()});const d=()=>{c.classList.add($.close),u.destroy()};return d}(window.RLQ||(window.RLQ=[])).push([["mediawiki.base","mediawiki.user"],()=>{mw.user.isAnon()&&L(),mw.hook("MoeAuthModal").fire({preload:L,create:b,show:U,renderIframe:I})}]),g.create=b,g.preload=L,g.renderIframe=I,g.show=U,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});

;(function () {
function injectCSS(payload) {
  const style = document.createElement("style");
  style.dataset.vitePackage = payload.packageName;
  style.dataset.viteFile = payload.fileName;
  style.innerHTML = payload.source;
  document.head.appendChild(style);
}
const cssEntries = [{"fileName":"index.css","name":"index.css","names":["index.css"],"needsCodeReference":false,"originalFileName":"style.css","originalFileNames":["style.css"],"source":"._moe_auth_modal_35ij6_1{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#00000080;box-shadow:0 0 0 999vmax #00000080;display:flex;justify-content:center;align-items:center;z-index:1000;overflow:hidden;transition:opacity .25s ease-in-out,transform .25s ease-in-out;opacity:.1;transform:scale(0)}._moe_auth_modal_35ij6_1._open_35ij6_18{opacity:1;transform:scale(1)}._moe_auth_modal_35ij6_1._close_35ij6_22{opacity:0;transform:scale(.25)}._moe_auth_modal_35ij6_1 iframe{width:100%;height:100%;border:none;overflow:hidden}\n","type":"asset","packageName":"MoeAuthModal"}];
cssEntries.forEach(injectCSS);
})()
